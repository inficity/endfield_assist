{% extends "base.html" %}

{% block title %}트리 시각화 - Endfield Recipe Tree{% endblock %}

{% block content %}
<div class="tree-page">
    <div class="search-section">
        <h2>제작 트리 시각화</h2>
        <div class="quick-buttons">
            <button class="quick-btn" data-item="large_canyon_battery">
                <img src="/static/icons/large_canyon_battery.png" onerror="this.style.display='none'">
                <span>대용량 협곡 배터리</span>
            </button>
            <button class="quick-btn" data-item="buckwheat_healing_capsule_l">
                <img src="/static/icons/buckwheat_healing_capsule_l.png" onerror="this.style.display='none'">
                <span>메밀꽃 치유 캡슐(대)</span>
            </button>
            <button class="quick-btn" data-item="citron_canned_l">
                <img src="/static/icons/citron_canned_l.png" onerror="this.style.display='none'">
                <span>시트론 통조림(대)</span>
            </button>
        </div>

        <!-- 멀티 아이템 선택 영역 -->
        <div class="multi-item-section">
            <div class="multi-item-header">
                <h3>생산 아이템 목록</h3>
                <button id="add-item-btn" class="btn btn-small btn-primary">+ 아이템 추가</button>
            </div>
            <div id="multi-item-list" class="multi-item-list">
                <!-- 동적으로 아이템 행 추가 -->
            </div>
            <div id="add-item-form" class="add-item-form" style="display: none;">
                <div class="form-group">
                    <input type="text" id="new-item-search" placeholder="아이템 검색..." autocomplete="off">
                    <div id="new-autocomplete-list" class="autocomplete-items"></div>
                </div>
                <button id="cancel-add-btn" class="btn btn-small btn-secondary">취소</button>
            </div>
            <div class="multi-item-actions">
                <button id="show-multi-tree-btn" class="btn btn-primary">트리 계산</button>
                <button id="toggle-graph-btn" class="btn btn-secondary" onclick="toggleGraph()">그래프 숨기기</button>
            </div>
            <p class="split-hint">💡 그래프에서 중간재 노드를 클릭하면 분할점으로 설정할 수 있습니다.</p>
        </div>
    </div>

    <div class="tree-container">
        <div id="tree-network"></div>
    </div>

    <!-- 묶음별 요약 -->
    <div class="bundles-section" id="bundles-section" style="display: none;">
        <h3>공장 묶음별 요약</h3>
        <div id="bundles-container" class="bundles-container">
            <!-- 동적으로 묶음 카드 추가 -->
        </div>
    </div>

    <!-- 공장 부지 할당 -->
    <div class="site-allocation-section" id="site-allocation-section" style="display: none;">
        <div class="site-allocation-header">
            <h3>공장 부지 할당</h3>
            <div class="site-allocation-actions">
                <button id="auto-allocate-btn" class="btn btn-primary btn-small">자동 배치</button>
                <button id="reset-allocation-btn" class="btn btn-secondary btn-small">초기화</button>
            </div>
        </div>
        <div id="site-cards-container" class="site-cards-container">
            <!-- 동적으로 부지 카드 추가 -->
        </div>
        <div id="unassigned-bundles-container" class="unassigned-bundles-container">
            <!-- 미할당 묶음 표시 -->
        </div>
    </div>

    <div class="production-summary-section" id="production-summary-section" style="display: none;">
        <h3>전체 생산 라인 요약</h3>
        <div class="summary-tables">
            <div class="summary-table-container">
                <h4>생산 아이템</h4>
                <table class="data-table" id="production-items-table">
                    <thead>
                        <tr>
                            <th>아이템</th>
                            <th>설비</th>
                            <th>라인</th>
                            <th>필요량</th>
                            <th>실생산</th>
                            <th>잉여</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="summary-table-container">
                <h4>필요 원재료</h4>
                <table class="data-table" id="raw-materials-table">
                    <thead>
                        <tr>
                            <th>원재료</th>
                            <th>필요량</th>
                            <th>공급</th>
                            <th>실공급</th>
                            <th>잉여</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const items = {{ items | tojson | safe }};
    const recipes = {{ recipes | tojson | safe }};
</script>
<script src="/static/js/tree.js"></script>
{% endblock %}
